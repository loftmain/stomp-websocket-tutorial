<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #file-content {
        border: 1px solid #ccc;
        padding: 10px;
        height: 300px;
        overflow-y: scroll;
        background-color: #f9f9f9;
      }
      #file-content div {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <h1>File Monitor</h1>
    <form id="file-form">
      <label for="filePath">File Path:</label>
      <input
        type="text"
        id="filePath"
        placeholder="/path/to/file.txt"
        required
      />
      <button type="submit">Start Monitoring</button>
    </form>
    <h2>File Content:</h2>
    <div id="file-content"></div>

    <script>
      let stompClient = null;

      // WebSocket 연결 설정
      function connect() {
        const socket = new SockJS("/gs-guide-websocket");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
          console.log("Connected to WebSocket");

          // 초기 파일 내용 수신
          stompClient.subscribe("/topic/fileContent", (message) => {
            const contentDiv = document.getElementById("file-content");
            contentDiv.innerHTML = ""; // 기존 내용을 초기화
            const lines = JSON.parse(message.body);
            lines.forEach((line) => {
              const newLine = document.createElement("div");
              newLine.textContent = line;
              contentDiv.appendChild(newLine);
            });
          });

          // 실시간 파일 업데이트 수신
          stompClient.subscribe("/topic/fileUpdate", (message) => {
            const contentDiv = document.getElementById("file-content");
            const lines = JSON.parse(message.body);
            lines.forEach((line) => {
              const newLine = document.createElement("div");
              newLine.textContent = line;
              contentDiv.appendChild(newLine);
            });

            // 스크롤을 맨 아래로 이동
            contentDiv.scrollTop = contentDiv.scrollHeight;
          });
        });
      }

      // 파일 모니터링 요청
      document
        .getElementById("file-form")
        .addEventListener("submit", (event) => {
          event.preventDefault();
          const filePath = document.getElementById("filePath").value;

          if (stompClient) {
            stompClient.send("/app/readFile", {}, JSON.stringify({ filePath }));
            console.log(`Monitoring started for file: ${filePath}`);
          } else {
            alert("WebSocket is not connected.");
          }
        });

      // WebSocket 연결 시작
      connect();
    </script>
  </body>
</html>
